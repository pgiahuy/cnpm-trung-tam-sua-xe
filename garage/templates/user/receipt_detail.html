{% extends 'layout/base.html' %}

{% block content %}
<div class="container mt-4" id="print-area">

    {% if receipt.type == "BUY" %}
        <h2 class="text-center mb-3">HÓA ĐƠN MUA HÀNG</h2>
    {% else %}
        <h2 class="text-center mb-3">HÓA ĐƠN SỬA CHỮA</h2>
    {% endif %}
    <hr>

    <!-- ===== Customer & Invoice Info ===== -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row">

                <div class="col-md-6">
                    <p class="fw-bold mb-2">Khách hàng</p>
                    <p class="mb-1">Tên: {{ receipt.customer.full_name }}</p>
                    <p class="mb-1">SĐT: {{ receipt.customer.phone }}</p>
                    <p class="mb-0">Email: {{ receipt.customer.email }}</p>
                </div>

                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <p class="fw-bold mb-2">Hóa đơn</p>
                    <p class="mb-1 fw-bold">GARAGE CENTER</p>
                    <p class="mb-1">Mã HĐ: HD{{ receipt.id }}</p>
                    <p class="mb-0">
                        Loại:
                        {{ 'Sửa chữa' if receipt.type == 'REPAIR' else 'Mua hàng' }}
                    </p>
                </div>

            </div>
        </div>
    </div>

    <!-- ===== Items ===== -->
    <div class="card mb-3">
        <div class="card-body p-0">
            <table class="table table-bordered mb-0">
                <thead class="table-light">
                <tr>
                    <th style="width:40px"></th>
                    <th>Tên</th>
                    <th style="width:120px">Loại</th>
                    <th class="text-center" style="width:80px">SL</th>
                    <th class="text-end" style="width:140px">Đơn giá</th>
                    <th class="text-end" style="width:160px">Thành tiền</th>
                </tr>
                </thead>
                <tbody>
                {% for item in receipt.items %}
                <tr>
                    <td>{{ loop.index }}</td>

                    <td>
                        {% if item.service %}
                            {{ item.service.name }}
                        {% elif item.spare_part %}
                            {{ item.spare_part.name }}
                        {% endif %}
                    </td>

                    <td>
                        {{ 'Tiền công' if item.item_type.name == 'SERVICE' else 'Phụ tùng' }}
                    </td>

                    <td class="text-center">{{ item.quantity }}</td>

                    <td class="text-end">
                        {{ "{:,.0f}".format(item.unit_price) }} ₫
                    </td>

                    <td class="text-end">
                        {{ "{:,.0f}".format(item.total_price) }} ₫
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ===== Total & Payment ===== -->
    <div class="card">
        <div class="card-body">
            <div class="row justify-content-between">

                <div class="col-md-4 total-box">
                    <p class="d-flex justify-content-between">
                        <span>Tạm tính:</span>
                        <strong>{{ "{:,.0f}".format(receipt.subtotal) }} ₫</strong>
                    </p>

                    <p class="d-flex justify-content-between">
                        <span>VAT ({{ receipt.vat_rate * 100 }}%):</span>
                        <strong>
                            {{ "{:,.0f}".format(receipt.subtotal * receipt.vat_rate) }} ₫
                        </strong>
                    </p>

                    <hr>

                    <p class="d-flex justify-content-between fs-5">
                        <span>Tổng thanh toán:</span>
                        <strong class="text-danger">
                            {{ "{:,.0f}".format(receipt.total_paid) }} ₫
                        </strong>
                    </p>
                </div>

                <div class="col-md-4 mt-3 mt-md-0">
                    <div class="border border-danger rounded p-3 text-center">
                        <h4 class="text-danger mb-2 fw-bold">ĐÃ THANH TOÁN</h4>
                        <p class="mb-1">
                            <strong>Ngày:</strong>
                            {{ receipt.paid_at.strftime('%d/%m/%Y %H:%M') }}
                        </p>
                        <p class="mb-0">
                            <strong>PTTT:</strong> {{ receipt.payment_method }}
                        </p>
                    </div>

                    <div class="text-end mt-3 no-print">
                        <button class="btn btn-outline-primary" onclick="window.print()">
                            In hóa đơn
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<style>
#print-area {
    max-width: 800px;
    margin: auto;
    padding: 24px;
    background: #fff;
    font-size: 14px;
}

h2 {
    font-weight: 700;
    letter-spacing: 1px;
}

.card {
    border-radius: 6px;
}

.table th,
.table td {
    vertical-align: middle;
    padding: 8px;
}

.table th {
    font-weight: 600;
}

.total-box p {
    margin-bottom: 6px;
}

@media print {
    body * {
        visibility: hidden;
    }

    #print-area,
    #print-area * {
        visibility: visible;
    }

    #print-area {
        position: absolute;
        inset: 0;
        width: 100% !important;
        padding: 16px;
        font-size: 13px;
    }

    .card {
        border: none;
        box-shadow: none;
    }


    .no-print {
        display: none !important;
    }
}
</style>
{% endblock %}
