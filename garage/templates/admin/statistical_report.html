{% extends 'admin/master.html' %}
{% block body %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<div id="flash-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 320px;"></div>

<div class="container-fluid py-4 px-lg-4">

    <div class="card shadow-sm border-0 mb-4" style="border-radius: 12px;">
        <div class="card-body p-3">
            <div class="row align-items-center g-3">
                <div class="col-xl-4 col-md-12">
                    <h5 class="fw-bold mb-0 d-flex align-items-center">
                        T·ªïng Quan Kinh Doanh
                    </h5>
                </div>
                <div class="col-xl-8 col-md-12">
                    <form id="filterForm" class="d-flex justify-content-xl-end align-items-center gap-2 flex-wrap">
                        <div class="btn-group btn-group-sm me-2 shadow-none">
                            <button type="button" class="btn btn-outline-secondary border-secondary-subtle"
                                    onclick="setQuickDate('week')">Tu·∫ßn n√†y
                            </button>
                            <button type="button" class="btn btn-outline-secondary border-secondary-subtle"
                                    onclick="setQuickDate('month')">Th√°ng n√†y
                            </button>
                            <button type="button" class="btn btn-outline-secondary border-secondary-subtle"
                                    onclick="setQuickDate('lastMonth')">Th√°ng tr∆∞·ªõc
                            </button>
                        </div>

                        <div class="input-group input-group-sm w-auto custom-date-picker shadow-sm">
                            <input type="date" id="startDate" name="startDate"
                                   class="form-control border-0 bg-light px-2">
                            <span class="input-group-text bg-light border-0 text-muted"><i
                                    class="fas fa-arrow-right small"></i></span>
                            <input type="date" id="endDate" name="endDate" class="form-control border-0 bg-light px-2">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4" style="border-radius: 12px;">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center pt-3 px-4">
            <h6 class="fw-bold mb-0 text-secondary"><span class="me-2">üìä</span>Th·ªëng k√™ doanh thu</h6>
            <select id="revenueMode"
                    class="form-select form-select-sm w-auto border-0 bg-light rounded-pill px-3 shadow-none">
                <option value="month">Theo th√°ng</option>
                <option value="day">Theo ng√†y</option>
            </select>
        </div>
        <div class="card-body px-4 pb-4">
            <canvas id="revenueChart" style="max-height: 320px;"></canvas>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 12px;">
                <div class="card-header bg-white border-0 pt-3 px-4"><h6 class="fw-bold mb-0 text-secondary">üöó T·ª∑ l·ªá xe
                    ƒë·∫øn s·ª≠a</h6></div>
                <div class="card-body px-4 pb-4">
                    <canvas id="vehicleChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 12px;">
                <div class="card-header bg-white border-0 pt-3 px-4"><h6 class="fw-bold mb-0 text-secondary">‚ö†Ô∏è L·ªói
                    th∆∞·ªùng g·∫∑p</h6></div>
                <div class="card-body px-4 pb-4">
                    <canvas id="errorChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden mt-4" style="border-radius: 15px;">
        <div class="card-header bg-success text-white py-3"
             style="background: linear-gradient(45deg, #28a745, #218838);">
            <h5 class="mb-0 d-flex align-items-center small text-uppercase tracking-wider">
                Xu·∫•t B√°o C√°o Excel T√πy Ch·ªçn
            </h5>
        </div>
        <div class="card-body bg-white p-4">
            <form action="/admin/statistical-report/export-excel" method="POST" id="exportForm">
                <input type="hidden" name="startDate" id="exportStartDate">
                <input type="hidden" name="endDate" id="exportEndDate">

                <div class="row align-items-center g-4">
                    <div class="col-lg-8">
                        <label class="form-label fw-bold text-secondary mb-3">N·ªôi dung b√°o c√°o</label>
                        <div class="row g-2 px-1">
                            <div class="col-md-3 col-6">
                                <div class="form-check custom-checkbox-soft">
                                    <input class="form-check-input" type="checkbox" name="sections" value="revenue_day"
                                           id="c1" checked>
                                    <label class="form-check-label" for="c1">Doanh thu ng√†y</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check custom-checkbox-soft">
                                    <input class="form-check-input" type="checkbox" name="sections"
                                           value="revenue_month" id="c2" checked>
                                    <label class="form-check-label" for="c2">Doanh thu th√°ng</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check custom-checkbox-soft">
                                    <input class="form-check-input" type="checkbox" name="sections"
                                           value="vehicle_stats" id="c3">
                                    <label class="form-check-label" for="c3">T·ª∑ l·ªá xe</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check custom-checkbox-soft">
                                    <input class="form-check-input" type="checkbox" name="sections" value="error_stats"
                                           id="c4">
                                    <label class="form-check-label" for="c4">L·ªói th∆∞·ªùng g·∫∑p</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <button type="submit"
                                class="btn btn-success px-5 py-2 fw-bold shadow-sm rounded-pill btn-hover-effect">
                            XU·∫§T B√ÅO C√ÅO EXCEL
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    body { background-color: #f8fafc; color: #334155; font-family: 'Inter', sans-serif; }
    .card { border-radius: 12px !important; border: 1px solid rgba(0,0,0,0.05); transition: all 0.2s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.04) !important; }

    .custom-date-picker {
        border-radius: 30px !important;
        overflow: hidden;
        border: 1px solid #e2e8f0 !important;
        padding: 2px 8px;
        background: #f8fafc;
    }
    .custom-date-picker input {
        font-weight: 500;
        color: #475569;
        max-width: 135px;
    }

    .custom-checkbox-soft .form-check-input {
        width: 1.2rem;
        height: 1.2rem;
        border-radius: 4px;
        cursor: pointer;
    }
    .custom-checkbox-soft .form-check-input:checked {
        background-color: #10b981;
        border-color: #10b981;
    }

    .btn-hover-effect {
        transition: all 0.3s ease;
        border-radius: 50px;
    }
    .btn-hover-effect:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3) !important;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let charts = { revenue: null, vehicle: null, error: null };
    let dataStore = { day: {}, month: {}, vehicle: {}, error: {} };

    const formatDateLocal = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    };

    const parseDate = (str) => {
        const p = str.split('/');
        return p.length === 3 ? new Date(p[2], p[1] - 1, p[0]) : new Date(p[1], p[0] - 1, 1);
    };

    function drawRevenueChart(mode) {
        const rawData = mode === 'day' ? dataStore.day : dataStore.month;
        const sortedData = Object.entries(rawData)
            .map(([label, value]) => ({ label, value }))
            .sort((a, b) => parseDate(a.label) - parseDate(b.label));

        const labels = sortedData.map(d => d.label);
        const values = sortedData.map(d => d.value);

        if (charts.revenue) charts.revenue.destroy();
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(13, 110, 253, 0.2)');
        gradient.addColorStop(1, 'rgba(13, 110, 253, 0)');

        charts.revenue = new Chart(ctx, {
            type: mode === 'day' ? 'line' : 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Doanh thu (VNƒê)',
                    data: values,
                    backgroundColor: mode === 'day' ? gradient : '#0d6efd',
                    borderColor: '#0d6efd',
                    borderWidth: 2,
                    fill: mode === 'day',
                    tension: 0.4,
                    pointRadius: mode === 'day' ? 4 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (ctx) => `Doanh thu: ${ctx.raw.toLocaleString('vi-VN')} VNƒê` } }
                },
                scales: {
                    y: { ticks: { callback: (v) => v.toLocaleString('vi-VN') + ' ƒë' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    async function autoRefresh() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (!start || !end) return;

        try {
            document.getElementById('revenueChart').style.opacity = '0.5';
            const res = await fetch(`/admin/statistical-report/api/data?start=${start}&end=${end}`);
            const json = await res.json();

            dataStore = {
                day: json.revenue_day,
                month: json.revenue_month,
                vehicle: json.vehicle_stats,
                error: json.error_stats
            };

            drawRevenueChart(document.getElementById('revenueMode').value);
            initSecondaryCharts();
            document.getElementById('revenueChart').style.opacity = '1';
        } catch (err) { console.error("L·ªói fetch:", err); }
    }

    function setQuickDate(type) {
        const now = new Date();
        let start = new Date();
        let end = new Date();

        if (type === 'week') {
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
            start.setDate(diff);
        } else if (type === 'month') {
            start = new Date(now.getFullYear(), now.getMonth(), 1);
        } else if (type === 'lastMonth') {
            start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            end = new Date(now.getFullYear(), now.getMonth(), 0);
        }

        document.getElementById('startDate').value = formatDateLocal(start);
        document.getElementById('endDate').value = formatDateLocal(end);

        autoRefresh();
    }

    function initSecondaryCharts() {
        if (charts.vehicle) charts.vehicle.destroy();
        charts.vehicle = new Chart(document.getElementById('vehicleChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(dataStore.vehicle),
                datasets: [{ data: Object.values(dataStore.vehicle), backgroundColor: ['#4e73df', '#f6c23e', '#e74a3b'] }]
            },
            options: { cutout: '75%', plugins: { legend: { position: 'bottom' } } }
        });

        const sortedErrors = Object.entries(dataStore.error).sort((a, b) => b[1] - a[1]);
        if (charts.error) charts.error.destroy();
        charts.error = new Chart(document.getElementById('errorChart'), {
            type: 'bar',
            data: {
                labels: sortedErrors.map(i => i[0]),
                datasets: [{ data: sortedErrors.map(i => i[1]), backgroundColor: '#94a3b8', borderRadius: 10 }]
            },
            options: { indexAxis: 'y', plugins: { legend: { display: false } } }
        });
    }

    function syncExportDates() {
    document.getElementById('exportStartDate').value = document.getElementById('startDate').value;
    document.getElementById('exportEndDate').value = document.getElementById('endDate').value;
}


    document.getElementById('exportForm').addEventListener('submit', function(event) {
    syncExportDates();

    const selectedCheckboxes = document.querySelectorAll('input[name="sections"]:checked');

    if (selectedCheckboxes.length === 0) {
        event.preventDefault();
        showJSFlash("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt n·ªôi dung ƒë·ªÉ xu·∫•t b√°o c√°o!", "warning");
        return;
    }

    let hasSelectedData = false;
    let missingSections = [];

    selectedCheckboxes.forEach(cb => {
        const sectionValue = cb.value;
        let isEmpty = false;

        if (sectionValue === 'revenue_day' && Object.keys(dataStore.day).length === 0) isEmpty = true;
        if (sectionValue === 'revenue_month' && Object.keys(dataStore.month).length === 0) isEmpty = true;
        if (sectionValue === 'vehicle_stats' && Object.keys(dataStore.vehicle).length === 0) isEmpty = true;
        if (sectionValue === 'error_stats' && Object.keys(dataStore.error).length === 0) isEmpty = true;

        if (!isEmpty) {
            hasSelectedData = true;
        } else {
            missingSections.push(cb.nextElementSibling.innerText);
        }
    });

    if (!hasSelectedData) {
        event.preventDefault();
        const sectionNames = missingSections.join(", ");
        showJSFlash(`L·ªói: C√°c m·ª•c b·∫°n ch·ªçn (${sectionNames}) kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!`, "danger");
    }
});
    window.addEventListener('DOMContentLoaded', () => {
        const today = formatDateLocal(new Date());
        document.getElementById('startDate').max = today;
        document.getElementById('endDate').max = today;

        setQuickDate('month');

        document.getElementById('revenueMode').onchange = (e) => drawRevenueChart(e.target.value);
        document.getElementById('startDate').onchange = autoRefresh;
        document.getElementById('endDate').onchange = autoRefresh;
    });

    function showJSFlash(message, category = 'danger') {
        const container = document.getElementById('flash-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `alert alert-${category} alert-dismissible fade show shadow-lg border-0`;
        toast.style.borderRadius = "12px";

        toast.innerHTML = `
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <div>${message.trim()}</div>
                </div>
                <span style="cursor:pointer; margin-left: 15px; font-weight: bold; line-height: 1;" onclick="this.parentElement.parentElement.remove()">&times;</span>
            </div>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }
        }, 3000);
    }
</script>
{% endblock %}