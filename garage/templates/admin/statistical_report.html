{% extends 'admin/master.html' %}

{% block body %}
<hr class="solid">

    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">üìä Th·ªëng k√™ doanh thu</h5>
            <select id="revenueMode" class="form-select w-auto">
                <option value="month">theo th√°ng</option>
                <option value="day">theo ng√†y</option>
            </select>
        </div>
        <div class="card-body"><canvas id="revenueChart" height="100"></canvas></div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card"><div class="card-header bg-light">üöó T·ª∑ l·ªá xe ƒë·∫øn s·ª≠a</div><div class="card-body"><canvas id="vehicleChart"></canvas></div></div>
        </div>
        <div class="col-md-6">
            <div class="card"><div class="card-header bg-light">‚ö†Ô∏è L·ªói th∆∞·ªùng g·∫∑p</div><div class="card-body"><canvas id="errorChart"></canvas></div></div>
        </div>
    </div>

    <hr class="solid">

    <div class="card border-0 shadow-sm overflow-hidden mt-4" style="border-radius: 15px;">
        <div class="card-header bg-success text-white py-3" style="background: linear-gradient(45deg, #28a745, #218838);">
            <h5 class="mb-0 d-flex align-items-center"><i class="fas fa-file-excel me-2"></i> Xu·∫•t B√°o C√°o Excel T√πy Ch·ªçn</h5>
        </div>
        <div class="card-body bg-white p-4">
            <form method="POST">
                <div class="row g-4">
                    <div class="col-lg-5">
                        <label class="form-label fw-bold text-secondary mb-3"><i class="fas fa-list-check me-1"></i> 1. N·ªôi dung</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" name="sections" value="revenue_day" id="c1" checked>
                                    <label class="form-check-label" for="c1">Doanh thu ng√†y</label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" name="sections" value="revenue_month" id="c2" checked>
                                    <label class="form-check-label" for="c2">Doanh thu th√°ng</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" name="sections" value="vehicle_stats" id="c3">
                                    <label class="form-check-label" for="c3">T·ª∑ l·ªá xe</label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" name="sections" value="error_stats" id="c4">
                                    <label class="form-check-label" for="c4">L·ªói th∆∞·ªùng g·∫∑p</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-bold text-secondary mb-3"><i class="fas fa-calendar-alt me-1"></i> 2. Kho·∫£ng th·ªùi gian</label>
                        <div class="input-group shadow-sm" style="border-radius: 8px; overflow: hidden;">
                            <input type="date" id="startDate" name="startDate" class="form-control border-0">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-arrow-right text-muted"></i></span>
                            <input type="date" id="endDate" name="endDate" class="form-control border-0">
                        </div>
                    </div>
                    <div class="col-lg-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100 shadow-sm py-2 fw-bold btn-hover-effect">
                            T·∫¢I B√ÅO C√ÅO
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    const revenueDay = {{ revenue_day | safe }};
    const revenueMonth = {{ revenue_month | safe }};
    const vehicleData = {{ vehicle_stats | safe }};
    const errorData = {{ error_stats | safe }};


    window.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const firstDayStr = `${year}-${month}-01`;

    const todayStr = now.toISOString().split('T')[0];

    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');

    if (startInput) startInput.value = firstDayStr; // S·∫Ω lu√¥n l√† YYYY-MM-01
    if (endInput) endInput.value = todayStr;
});

    let revChart;
    function drawRev(mode) {
        const labels = mode === 'day' ? Object.keys(revenueDay) : Object.keys(revenueMonth);
        const data = mode === 'day' ? Object.values(revenueDay) : Object.values(revenueMonth);
        if(revChart) revChart.destroy();
        revChart = new Chart(document.getElementById('revenueChart'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Doanh thu (VNƒê)',
                    data,
                    backgroundColor: 'rgba(13, 110, 253, 0.8)',
                    borderColor: '#0d6efd',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }
    drawRev('month');
    document.getElementById('revenueMode').addEventListener('change', (e) => drawRev(e.target.value));

    new Chart(document.getElementById('vehicleChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(vehicleData),
            datasets: [{
                data: Object.values(vehicleData),
                backgroundColor: ['#ffc107', '#0dcaf0', '#dc3545', '#6610f2', '#fd7e14'],
                hoverOffset: 10
            }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
    });

    new Chart(document.getElementById('errorChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(errorData),
            datasets: [{
                label: 'S·ªë l·∫ßn g·∫∑p',
                data: Object.values(errorData),
                backgroundColor: 'rgba(108, 117, 125, 0.8)',
                borderRadius: 5
            }]
        },
        options: { indexAxis: 'y', plugins: { legend: { display: false } } }
    });
</script>
<style>
.custom-checkbox .form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.custom-checkbox label {
    font-size: 0.95rem;
    color: #444;
    cursor: pointer;
}

.btn-hover-effect {
    transition: all 0.3s ease;
    border: none;
}

.btn-hover-effect:hover {
    background-color: #218838 !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3) !important;
}

input[type="date"] {
    padding: 10px;
    color: #555;
}
</style>
{% endblock %}